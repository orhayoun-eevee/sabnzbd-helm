suite: sabnzbd chart contract
templates:
  - templates/all.yaml
tests:
  - it: renders expected default resource set and ingress host
    asserts:
      - hasDocuments:
          count: 16
      - documentIndex: 4
        equal:
          path: spec.hostnames[0]
          value: sabnzbd-k8s.orhayoun.com
      - documentIndex: 14
        equal:
          path: spec.instanceSelector.matchLabels["app.kubernetes.io/instance"]
          value: prometheus
      - documentIndex: 14
        equal:
          path: spec.instanceSelector.matchLabels["app.kubernetes.io/name"]
          value: grafana
      - documentIndex: 12
        equal:
          path: kind
          value: ServiceMonitor
      - documentSelector:
          path: kind
          value: DestinationRule
        equal:
          path: spec.host
          value: sabnzbd-http

  - it: wires sabnzbd application container security and pvc correctly
    asserts:
      - documentIndex: 1
        equal:
          path: spec.template.spec.containers[1].name
          value: sabnzbd
      - documentIndex: 1
        equal:
          path: spec.template.spec.containers[1].securityContext.readOnlyRootFilesystem
          value: true
      - documentIndex: 1
        equal:
          path: spec.template.spec.containers[1].securityContext.runAsUser
          value: 1010
      - documentIndex: 1
        equal:
          path: spec.template.spec.containers[1].securityContext.runAsGroup
          value: 1010
      - documentIndex: 15
        equal:
          path: metadata.name
          value: sabnzbd-config

  - it: keeps minimal scenario render compact and deterministic
    values:
      - scenarios/minimal.yaml
    asserts:
      - hasDocuments:
          count: 5

  - it: disables destination rule when explicitly turned off
    set:
      network:
        istio:
          destinationRule:
            enabled: false
    asserts:
      - hasDocuments:
          count: 15

  - it: applies grafana instance selector overrides from values
    set:
      metrics:
        grafana:
          instanceSelector:
            matchLabels:
              app.kubernetes.io/instance: observability
              app.kubernetes.io/name: grafana-primary
    asserts:
      - documentSelector:
          path: kind
          value: GrafanaDashboard
        equal:
          path: spec.instanceSelector.matchLabels["app.kubernetes.io/instance"]
          value: observability
      - documentSelector:
          path: kind
          value: GrafanaDashboard
        equal:
          path: spec.instanceSelector.matchLabels["app.kubernetes.io/name"]
          value: grafana-primary
