---
# Source: sabnzbd/templates/all.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: sabnzbd-default
  namespace: download-clients
  labels:
    app.kubernetes.io/component: network-policy
    app.kubernetes.io/instance: test-release
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: sabnzbd
    app.kubernetes.io/version: 4.5.3
    helm.sh/chart: sabnzbd-0.0.8
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: sabnzbd
      app.kubernetes.io/instance: test-release
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: istio-system
        podSelector:
          matchLabels:
            app.kubernetes.io/name: shared-platform-gateway
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: monitoring
        podSelector:
          matchLabels:
            app.kubernetes.io/name: prometheus
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: homeassistant
        podSelector:
          matchLabels:
            app.kubernetes.io/name: home-assistant
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: media-center
        podSelector:
          matchLabels:
            app.kubernetes.io/part-of: media-center
      ports:
      - port: 15008
        protocol: TCP
  egress:
    - ports:
      - port: 53
        protocol: UDP
      - port: 53
        protocol: TCP
      to:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: kube-system
        podSelector:
          matchLabels:
            k8s-app: kube-dns
    - ports:
      - port: 563
        protocol: TCP
      to:
      - ipBlock:
          cidr: 0.0.0.0/0
          except:
          - 10.42.0.0/16
          - 10.43.0.0/16
          - 192.168.0.0/16
    - ports:
      - port: 15008
        protocol: TCP
      to:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: istio-system
---
# Source: sabnzbd/templates/all.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sabnzbd
  namespace: download-clients
  labels:
    app.kubernetes.io/component: serviceaccount
    app.kubernetes.io/instance: test-release
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: sabnzbd
    app.kubernetes.io/version: 4.5.3
    helm.sh/chart: sabnzbd-0.0.8
  annotations:
    app.kubernetes.io/managed-by: argocd
    description: SABnzbd media center service account
automountServiceAccountToken: false
---
# Source: sabnzbd/templates/all.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sabnzbd-config
  namespace: download-clients
  labels:
    app.kubernetes.io/component: pvc
    app.kubernetes.io/instance: test-release
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: sabnzbd
    app.kubernetes.io/version: 4.5.3
    helm.sh/chart: sabnzbd-0.0.8
  annotations:
    helm.sh/resource-policy: keep
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn
  resources:
    requests:
      storage: 2Gi
---
# Source: sabnzbd/templates/all.yaml
apiVersion: v1
kind: Service
metadata:
  name: sabnzbd-http
  namespace: download-clients
  labels:
    app.kubernetes.io/component: service-http
    app.kubernetes.io/instance: test-release
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: sabnzbd
    app.kubernetes.io/version: 4.5.3
    helm.sh/chart: sabnzbd-0.0.8
  annotations:
    description: SABnzbd media center HTTP service
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8080
      targetPort: http
      protocol: TCP
  selector:
    app.kubernetes.io/name: sabnzbd
    app.kubernetes.io/instance: test-release
---
# Source: sabnzbd/templates/all.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sabnzbd
  namespace: download-clients
  labels:
    app.kubernetes.io/component: deployment
    app.kubernetes.io/instance: test-release
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: sabnzbd
    app.kubernetes.io/version: 4.5.3
    helm.sh/chart: sabnzbd-0.0.8
spec:
  replicas: 1
  revisionHistoryLimit: 3
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: sabnzbd
      app.kubernetes.io/instance: test-release
  template:
    metadata:
      labels:
        app.kubernetes.io/component: deployment
        app.kubernetes.io/instance: test-release
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: sabnzbd
        app.kubernetes.io/version: 4.5.3
        helm.sh/chart: sabnzbd-0.0.8
        app.kubernetes.io/part-of: download-clients
        logging.kubernetes.io/component: download-clients
        logging.kubernetes.io/service: sabnzbd
    spec:
      terminationGracePeriodSeconds: 60
      securityContext:
        fsGroup: 1010
        fsGroupChangePolicy: OnRootMismatch
        runAsNonRoot: true
        supplementalGroups: []
      serviceAccountName: sabnzbd
      nodeSelector:
        kubernetes.io/os: linux
      dnsPolicy: ClusterFirst
      automountServiceAccountToken: false
      enableServiceLinks: false
      containers:
        - name: exportarr
          image: ghcr.io/orhayoun/exportarr:v2.3.1@sha256:2650f6a501b1d691daf5dfe758068f44336d0bb1d443f9db2c94900244d423bc
          imagePullPolicy: IfNotPresent
          ports:
            - name: metrics
              containerPort: 9100
              protocol: TCP
          args:
            - sabnzbd
          env:
            - name: URL
              value: http://localhost:8080
            - name: CONFIG
              value: /config/sabnzbd.ini
            - name: PORT
              value: "9100"
            - name: ENABLE_ADDITIONAL_METRICS
              value: "false"
            - name: ENABLE_UNKNOWN_QUEUE_ITEMS
              value: "false"
          volumeMounts:
            - mountPath: /config
              name: config
              readOnly: true
          resources:
            limits:
              cpu: 100m
              ephemeral-storage: 100Mi
              memory: 64Mi
            requests:
              cpu: 10m
              ephemeral-storage: 100Mi
              memory: 32Mi
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /metrics
              port: metrics
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 5
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /metrics
              port: metrics
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          startupProbe:
            failureThreshold: 30
            httpGet:
              path: /metrics
              port: metrics
              scheme: HTTP
            initialDelaySeconds: 45
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 10
          securityContext:
            allowPrivilegeEscalation: false
            appArmorProfile:
              type: RuntimeDefault
            capabilities:
              drop:
              - ALL
            readOnlyRootFilesystem: true
            runAsGroup: 65534
            runAsNonRoot: true
            runAsUser: 65534
            seccompProfile:
              type: RuntimeDefault
        - name: sabnzbd
          image: ghcr.io/runlix/sabnzbd:release-4.5.5-latest@sha256:826caa03179efed2d9ebb636d1cfbe50ba9a7982d467aa3288ebdb6c52c7e803
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: TZ
              value: UTC
          volumeMounts:
            - mountPath: /config
              name: config
            - mountPath: /backup
              name: backup
            - mountPath: /downloads
              name: downloads
            - mountPath: /media
              name: media
            - mountPath: /tmp
              name: tmp
          resources:
            limits:
              cpu: 1000m
              ephemeral-storage: 2Gi
              memory: 2Gi
            requests:
              cpu: 1000m
              ephemeral-storage: 2Gi
              memory: 256Mi
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /
              port: http
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 10
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /
              port: http
              scheme: HTTP
            initialDelaySeconds: 15
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          startupProbe:
            failureThreshold: 30
            httpGet:
              path: /
              port: http
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 5
          securityContext:
            allowPrivilegeEscalation: false
            appArmorProfile:
              type: RuntimeDefault
            capabilities:
              drop:
              - ALL
            privileged: false
            readOnlyRootFilesystem: true
            runAsGroup: 1010
            runAsNonRoot: true
            runAsUser: 1010
            seccompProfile:
              type: RuntimeDefault
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: sabnzbd-config
        - name: downloads
          nfs:
            path: /mnt/vol1/media-center/downloads
            server: snorlax.orhayoun.com
        - name: media
          nfs:
            path: /mnt/vol1/media-center/media
            server: snorlax.orhayoun.com
        - name: backup
          nfs:
            path: /mnt/vol1/media-center/backup/sabnzbd
            server: snorlax.orhayoun.com
        - emptyDir:
            sizeLimit: 1Gi
          name: tmp
